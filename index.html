<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SeeSo Eye Tracking Web Demo</title>
  <link rel="stylesheet" href="./css/style.css" />
  <link rel="stylesheet" href="./css/rune-game.css" />
  <link rel="stylesheet" href="./css/rabbit.css" />
  <script src="./coi-serviceworker.js"></script>
  <style>
    /* Villian Modal Styles used for Typewriter Mode */
    #villain-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 30000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .villain-card {
      background: #1a1a1a;
      color: #f0f0f0;
      width: 90%;
      max-width: 500px;
      padding: 30px;
      border-radius: 12px;
      border: 2px solid #d32f2f;
      text-align: center;
      box-shadow: 0 0 30px rgba(211, 47, 47, 0.4);
      position: relative;
    }

    .villain-avatar {
      font-size: 4rem;
      margin-bottom: 10px;
    }

    .villain-title {
      font-family: 'Creepster', cursive, serif;
      color: #ff4444;
      font-size: 2rem;
      margin: 0 0 15px 0;
    }

    .quiz-question {
      font-size: 1.2rem;
      margin-bottom: 25px;
      line-height: 1.4;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .quiz-btn {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .quiz-btn:hover {
      background: #444;
      border-color: #888;
    }

    .quiz-btn.correct {
      background: #2e7d32;
      border-color: #1b5e20;
    }

    .quiz-btn.wrong {
      background: #c62828;
      border-color: #b71c1c;
    }

    /* Typewriter Paragraph Style */
    #book-content p {
      font-family: 'Crimson Text', serif;
      font-size: 1.5rem;
      line-height: 2.7;
      /* Increased by 50% */
      margin-bottom: 2rem;
      white-space: pre-wrap;
      /* Preserve formatting */
    }

    .cursor {
      display: inline-block;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      /*Ìè∞Ìä∏ ÌÅ¨Í∏∞Ïóê ÎπÑÎ°Ä */
      background-color: #f0c420;
      /* Gold Cursor */
      vertical-align: text-bottom;
      animation: blink 0.8s infinite;
      margin-left: 2px;
      transition: box-shadow 0.2s;
    }

    .cursor.glow-good {
      box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.6);
      /* Gold glow */
    }

    .cursor.glow-perfect {
      box-shadow: 0 0 20px 5px rgba(0, 255, 0, 0.8), 0 0 40px 10px rgba(0, 255, 0, 0.4);
      /* Strong Green glow */
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }
    }

    .fake-fixation {
      position: absolute;
      width: 30px;
      height: 30px;
      background: rgba(0, 255, 0, 0.4);
      /* Semi-transparent Green */
      border-radius: 50%;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
      animation: scaleIn 0.3s ease-out forwards;
      box-shadow: 0 0 5px rgba(0, 255, 0, 0.4);
    }

    @keyframes scaleIn {
      from {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }

      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    .villain-img {
      width: 150px;
      height: auto;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.6));
    }
  </style>
</head>

<body>
  <!-- 1. Eye Tracking Layer (Background/Debug) -->
  <div id="stage">
    <video id="preview" autoplay muted playsinline></video>
    <canvas id="output"></canvas>
  </div>

  <!-- 2. Global HUD (Debug Overlay) -->
  <div id="hud">
    <div id="status">Initializing...</div>
    <div id="gazeInfo">gaze: -</div>
    <div id="pills">
      <span class="pill" id="pillCoi">-</span>
      <span class="pill" id="pillPerm">-</span>
      <span class="pill" id="pillSdk">-</span>
      <span class="pill" id="pillTrack">-</span>
      <span class="pill" id="pillCal">-</span>
      <button id="btnRetry" type="button" style="pointer-events:all;">Reload SDK</button>
    </div>
  </div>

  <!-- 3. MAIN GAME UI CONTAINER -->
  <div id="game-ui">

    <!-- Top Navigation Header -->
    <header class="game-header">
      <div class="user-level">Rank: Apprentice</div>
      <div class="currency-badge">
        üíé <span id="gem-count">0</span> | üñãÔ∏è <span id="ink-count">0</span>
      </div>
    </header>

    <!-- SCREEN 0: HOME / LOBBY -->
    <section id="screen-home" class="screen active">
      <h1 class="title-logo">The Book Wardens</h1>
      <p style="color: #aaa; margin-bottom: 30px;">Rift of Pages - Day 1</p>

      <div style="margin-bottom: 20px;">
        <h3>Today's Mission:</h3>
        <p>"Alice's Adventures in Wonderland"</p>
      </div>

      <button id="btn-start-game" class="btn-primary">Enter the Rift</button>
      <div id="loader-container"
        style="display:none; width: 220px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 20px auto; overflow: hidden; position: relative;">
        <div id="loader-bar"
          style="width: 0%; height: 100%; background: linear-gradient(90deg, #6200ea, #b000df); transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1); box-shadow: 0 0 10px #b000df;">
        </div>
      </div>
      <p style="font-size: 0.8rem; color: #555; margin-top: 20px;" id="perm-instruct">Please allow camera access when
        prompted.</p>
    </section>

    <!-- SCREEN 0.5: CALIBRATION -->
    <section id="screen-calibration" class="screen">
      <div
        style="position: fixed; top: 0; left: 0; z-index: 20000; pointer-events: none; width: 100%; height: 100%; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 100px;">
        <div id="calibration-status" style="display: none;"></div>
        <button id="btn-calibration-start" class="btn-primary" style="display:none; pointer-events:auto;">Start
          Point</button>
      </div>
    </section>

    <!-- Calibration Fail Popup -->
    <div id="cal-fail-popup"
      style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; z-index: 30000; background: rgba(0,0,0,0.85); flex-direction: column; align-items: center; justify-content: center;">
      <h2 style="color: #ff4444; margin-bottom: 20px;">Calibration Failed</h2>
      <p style="color: #ddd; text-align: center; margin-bottom: 30px; max-width: 80%;">
        Calibration timed out or failed.<br>Retry for better accuracy?
      </p>
      <div style="display: flex; gap: 20px;">
        <button id="btn-cal-retry" class="btn-primary" style="background: #444;">Retry</button>
        <button id="btn-cal-skip" class="btn-primary">Skip</button>
      </div>
    </div>

    <!-- SCREEN 1: WORD FORGE (Vocab) -->
    <section id="screen-word" class="screen">
      <div style="text-align: center; margin-bottom: 10px; color: var(--primary-accent);">
        WORD FORGE (1/3)
      </div>

      <div class="word-card">
        <div class="word-image-placeholder">
          [Magic Image Placeholder]
        </div>
        <h2 class="word-title" id="vocab-word">Luminous</h2>
        <p style="color: #bbb; margin-bottom: 20px;">"The <b>luminous</b> mushroom lit up the dark cave."</p>

        <div id="vocab-options">
          <button class="option-btn" onclick="Game.checkVocab(0)">A. Very heavy and dark</button>
          <button class="option-btn" onclick="Game.checkVocab(1)">B. Full of light / Shining</button>
          <button class="option-btn" onclick="Game.checkVocab(2)">C. Related to the moon</button>
        </div>
      </div>
    </section>

    <!-- SCREEN 1.5: THE WHITE RABBIT (Eye Tracking Demo) -->
    <section id="screen-owl" class="screen">
      <h2 style="color: #f0c420; text-shadow: 0 0 10px #f0c420; font-family: 'Cinzel', serif;">Misty the Chronicler</h2>
      <p style="color: #aaa; margin-bottom: 40px;">"Oh dear! Oh dear! I shall be too late!" - Follow the Rabbit's
        gaze...</p>

      <div class="rabbit-container">
        <!-- Rabbit character image -->
        <div class="rabbit-image"></div>

        <!-- Eye tracking overlays -->
        <div class="rabbit-eye-overlay left-eye-overlay">
          <div class="pupil" id="eye-left-pupil"></div>
        </div>
        <div class="rabbit-eye-overlay right-eye-overlay">
          <div class="pupil" id="eye-right-pupil"></div>
        </div>
      </div>

      <button class="btn-primary" onclick="Game.startReadingFromOwl()" style="margin-top: 60px;">
        Follow the Rabbit
      </button>
    </section>

    <!-- SCREEN 2: READING RIFT (Eye Tracking Gameplay) -->
    <section id="screen-read" class="screen">
      <div style="margin-bottom: 10px; text-align: center;">
        <span style="background: #333; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem;">
          Chapter 1: Down the Rabbit-Hole
        </span>
      </div>

      <div id="book-content" class="book-container"
        style="height: 60vh; overflow: hidden; padding: 20px; border: 1px solid #444; border-radius: 8px; background: rgba(0,0,0,0.3); column-fill: auto; column-width: 100%; column-gap: 80px;">
        <!-- Text will be injected here by JS -->
        <p>Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do: once
          or twice she had peeped into the book her sister was reading, but it had no <span
            class="rift-word">pictures</span> or <span class="rift-word">conversations</span> in it,
          ‚Äúand what is the use of a book,‚Äù thought Alice ‚Äúwithout <span class="rift-word">pictures</span> or <span
            class="rift-word">conversations</span>?‚Äù</p>
        <p>So she was considering in her own mind (as well as she could, for the hot day made her feel very sleepy and
          stupid), whether the pleasure of making a <span class="rift-word">daisy-chain</span> would be worth the
          trouble of getting up and picking the
          daisies, when suddenly a <span class="rift-word">White Rabbit</span> with <span class="rift-word">pink
            eyes</span> ran close by her.</p>
        <p>There was nothing so VERY remarkable in that; nor did Alice think it so VERY much out of the way to hear the
          Rabbit say to itself, ‚ÄúOh dear! Oh dear! I shall be late!‚Äù (when she thought it over afterwards, it occurred
          to her that she ought to have wondered at this, but at the time it all seemed quite natural); but when the
          Rabbit actually TOOK A <span class="rift-word">WATCH</span> OUT OF ITS <span
            class="rift-word">WAISTCOAT-POCKET</span>, and looked at it, and then hurried on, Alice started
          to her feet, for it flashed across her mind that she had never before seen a rabbit with either a
          <span class="rift-word">waistcoat-pocket</span>, or a <span class="rift-word">watch</span> to take out of it,
          and <span class="rift-word">burning with curiosity</span>, she ran across the field after it,
          and fortunately was just in time to see it pop down a large <span class="rift-word">rabbit-hole</span> under
          the hedge.
        </p>
        <p>In another moment down went Alice after it, never once considering how in the world she was to get out again.
        </p>
        <p>The <span class="rift-word">rabbit-hole</span> went straight on like a tunnel for some way, and then dipped
          suddenly down, so suddenly that
          Alice had not a moment to think about stopping herself before she found herself falling down a very <span
            class="rift-word">deep well</span>.
        </p>
        <p>Either the well was very deep, or she fell very slowly, for she had plenty of time as she went down to look
          about her and to wonder what was going to happen next. First, she tried to look down and make out what she was
          coming to, but it was too dark to see anything; then she looked at the sides of the well, and noticed that
          they were filled with <span class="rift-word">cupboards</span> and <span
            class="rift-word">book-shelves</span>; here and there she saw <span class="rift-word">maps</span> and <span
            class="rift-word">pictures</span> hung upon pegs. She
          took down a jar from one of the shelves as she passed; it was labelled ‚Äú<span class="rift-word">ORANGE
            MARMALADE</span>‚Äù, but to her great
          disappointment it was <span class="rift-word">empty</span>: she did not like to drop the jar for fear of
          killing somebody, so managed to put
          it into one of the cupboards as she fell past it.</p>
        <p>‚ÄúWell!‚Äù thought Alice to herself, ‚Äúafter such a fall as this, I shall think nothing of tumbling down stairs!
          How <span class="rift-word">brave</span> they‚Äôll all think me at home! Why, I wouldn‚Äôt say anything about it,
          even if I fell off the top of
          the house!‚Äù (Which was very likely true.)</p>
        <p>Down, down, down. Would the fall NEVER come to an end! ‚ÄúI wonder how many miles I‚Äôve fallen by this time?‚Äù
          she said aloud. ‚ÄúI must be getting somewhere near the <span class="rift-word">centre of the earth</span>. Let
          me see: that would be four
          thousand miles down, I think‚Äî‚Äù (for, you see, Alice had learnt several things of this sort in her lessons in
          the schoolroom, and though this was not a VERY good opportunity for showing off her knowledge, as there was no
          one to listen to her, still it was good practice to say it over) ‚Äú‚Äîyes, that‚Äôs about the right distance‚Äîbut
          then I wonder what <span class="rift-word">Latitude</span> or <span class="rift-word">Longitude</span> I‚Äôve
          got to?‚Äù (Alice had no idea what <span class="rift-word">Latitude</span> was, or <span
            class="rift-word">Longitude</span>
          either, but thought they were nice grand words to say.)</p>
        <p>Presently she began again. ‚ÄúI wonder if I shall fall right through the earth! How funny it‚Äôll seem to come
          out among the people that walk with their heads downward! The <span class="rift-word">Antipathies</span>, I
          think‚Äî‚Äù (she was rather glad
          there WAS no one listening, this time, as it didn‚Äôt sound at all the right word) ‚Äú‚Äîbut I shall have to ask
          them what the name of the country is, you know. Please, Ma‚Äôam, is this <span class="rift-word">New
            Zealand</span> or <span class="rift-word">Australia</span>?‚Äù (and she
          tried to <span class="rift-word">curtsey</span> as she spoke‚Äîfancy <span class="rift-word">curtseying</span>
          as you‚Äôre falling through the air! Do you think you could
          manage it?) ‚ÄúAnd what an ignorant little girl she‚Äôll think me for asking! No, it‚Äôll never do to ask: perhaps I
          shall see it written up somewhere.‚Äù</p>
        <p>Down, down, down. There was nothing else to do, so Alice soon began talking again. ‚Äú<span
            class="rift-word">Dinah</span>‚Äôll miss me very
          much to-night, I should think!‚Äù (<span class="rift-word">Dinah</span> was the cat.) ‚ÄúI hope they‚Äôll remember
          her <span class="rift-word">saucer of milk</span> at tea-time.
          <span class="rift-word">Dinah</span> my dear! I wish you were down here with me! There are no mice in the air,
          I‚Äôm afraid, but you might
          catch a <span class="rift-word">bat</span>, and that‚Äôs very like a mouse, you know. But do cats eat <span
            class="rift-word">bats</span>, I wonder?‚Äù And here Alice began to
          get rather sleepy, and went on saying to herself, in a dreamy sort of way, ‚ÄúDo cats eat <span
            class="rift-word">bats</span>? Do cats eat
          <span class="rift-word">bats</span>?‚Äù and sometimes, ‚ÄúDo <span class="rift-word">bats</span> eat cats?‚Äù for,
          you see, as she couldn‚Äôt answer either question, it didn‚Äôt much
          matter which way she put it. She felt that she was dozing off, and had just begun to dream that she was
          walking hand in hand with <span class="rift-word">Dinah</span>, and saying to her very earnestly, ‚ÄúNow, <span
            class="rift-word">Dinah</span>, tell me the truth: did you
          ever eat a <span class="rift-word">bat</span>?‚Äù when suddenly, thump! thump! down she came upon a heap of
          sticks and dry leaves, and the fall
          was over.
        </p>
      </div>

      <!-- Speed Controls -->
      <div id="read-controls"
        style="display: flex; justify-content: center; align-items: center; margin-top: 20px; width: 100%; gap: 20px;">
        <button class="btn-secondary" onclick="Game.typewriter.changeSpeed(-10)"
          style="font-size: 1.5rem; width: 50px;">-</button>
        <div style="text-align: center; position: relative;">
          <div id="gaze-feedback-label" style="font-size: 1rem; font-weight: bold; height: 1.5em; margin-bottom: 2px;">
          </div>
          <span id="wpm-display" style="color: #f0c420; font-size: 1.5rem; font-weight: bold; display: block;">0
            WPM</span>
          <span style="color: #888; font-size: 0.8rem;">Reading Speed</span>
        </div>
        <button class="btn-secondary" onclick="Game.typewriter.changeSpeed(10)"
          style="font-size: 1.5rem; width: 50px;">+</button>
      </div>

      <div class="rift-seal-bar" style="display:none;">
        <div id="read-progress" class="rift-seal-fill"></div>
      </div>
      <p style="margin-top: 10px; font-size: 0.8rem; color: #777;">Read to seal the rift...</p>

      <button id="btn-confront-villain" class="btn-primary"
        style="display: none; margin-top: 30px; background: #ff4444; width: 100%;" onclick="Game.confrontVillain()">
        Confront the Ink Shadow
      </button>
    </section>

    <!-- SCREEN 3: BOSS BATTLE (Comprehension) -->
    <section id="screen-boss" class="screen">
      <img src="./ink_shadow_boss.png" class="villain-img" alt="The Ink Shadow"
        style="width: 200px; margin-bottom: 20px;">
      <div class="boss-dialogue">
        <h3 style="margin: 0 0 10px 0; color: #f00;">The Ink Shadow asks:</h3>
        <p id="boss-question">"Why did Alice follow the Rabbit?"</p>
      </div>

      <div id="boss-options" class="quiz-options" style="width: 100%; max-width: 500px; margin-top: 20px;">
        <!-- Options will be injected -->
      </div>
    </section>

    <!-- SCREEN 4: VICTORY -->
    <section id="screen-win" class="screen">
      <h1 style="color: gold;">Rift Sealed!</h1>
      <p>You have restored the meaning of this page.</p>
      <div style="font-size: 3rem; margin: 20px;">üíé +50</div>
      <button class="btn-primary" onclick="Game.typewriter.showFullTextReview()">Review Reading</button>
    </section>

    <!-- SCREEN 5: FULL TEXT REVIEW -->
    <section id="screen-review" class="screen"
      style="justify-content: flex-start; padding-top: 80px; overflow-y: auto;">
      <h2 style="color: #fff; margin-bottom: 20px;">Today's Reading</h2>
      <div id="full-text-container" style="
            width: 90%; 
            max-width: 800px; 
            height: 60vh; 
            overflow-y: auto; 
            background: rgba(255,255,255,0.1); 
            padding: 20px; 
            border-radius: 8px; 
            text-align: left; 
            font-family: 'Crimson Text', serif; 
            font-size: 1.2rem; 
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;">
        <!-- Full text injected here -->
      </div>
      <div style="display:flex; gap:10px; margin-top: 10px;">
        <button class="btn-primary" onclick="Game.typewriter.showSummaryShare()">Next</button>
        <button class="btn-primary" style="background:#444;"
          onclick="if(window.gazeDataManager) window.gazeDataManager.exportCSV()">Gaze Data Output</button>
      </div>
    </section>

    <!-- SCREEN 6: SUMMARY & SHARE -->
    <section id="screen-share" class="screen">
      <h2 style="color: #f0c420; margin-bottom: 20px;">Reading Complete</h2>
      <div class="share-card"
        style="background: #fff; padding: 10px; border-radius: 10px; max-width: 400px; margin-bottom: 20px;">
        <img src="./alice_summary_card.png" alt="Summary Card" style="width: 100%; border-radius: 5px; display: block;">
      </div>
      <div style="display: flex; gap: 15px;">
        <button class="btn-primary" onclick="Game.typewriter.shareResult()">Share to Friends</button>
        <button class="btn-primary" style="background: #555;" onclick="location.reload()">Home</button>
      </div>
    </section>

  </div>

  <!-- Villain Modal (Moved here) -->
  <!-- Villain Modal (Moved here) -->
  <div id="villain-modal">
    <div class="villain-card">

      <!-- Reward Container -->
      <div id="reward-container"
        style="display:none; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 200px;">
        <div style="font-size: 3rem; margin-bottom: 15px;">üñãÔ∏è</div>
        <h2
          style="color: #f0c420; margin: 0 0 10px 0; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 2px;">
          Ink Collected</h2>
        <div id="reward-ink-value"
          style="font-size: 3.5rem; font-weight: bold; color: #fff; text-shadow: 0 0 15px #f0c420; font-family: 'Cinzel', serif;">
          +0</div>
      </div>

      <!-- Quiz Container -->
      <div id="quiz-container">
        <img src="./ink_shadow_boss.png" class="villain-img" alt="The Timekeeper">
        <h2 class="villain-title">The Timekeeper</h2>
        <p id="quiz-text" class="quiz-question">...</p>
        <div id="quiz-options" class="quiz-options"></div>
      </div>

    </div>
  </div>

  <!-- Scripts -->
  <!-- 1. Eye Tracking Core -->
  <script type="module" src="./js/app.js?v=2"></script>
  <!-- 2. Game Logic (This will be created next) -->
  <script src="./js/game.js"></script>
</body>

</html>